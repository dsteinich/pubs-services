<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="ipdsMessageLog">

    <resultMap id="result" type="IpdsMessageLog" extends="base.result">
        <id property="id" column="ipds_message_log_id"/>
        <result property="messageText" column="ipds_message"/>
        <result property="processingDetails" column="processing_details"/>
        <result property="prodId" column="prod_id"/>
        <result property="processType" column="process_type"/>
    </resultMap>

    <sql id="baseSelect">
        select ipds_message_log_id,
               xmlserialize(content ipds_message as text) ipds_message,
               processing_details,
               prod_id,
               process_type
          from ipds_message_log
    </sql>

    <insert id="add" parameterType="IpdsMessageLog">
        <selectKey keyProperty="id" resultType="Integer" order="BEFORE">
            select nextval('ipds_message_log_seq')
        </selectKey>
        insert into ipds_message_log (ipds_message_log_id, ipds_message, process_type, <include refid="base.auditCols"/>)
            values (#{id,jdbcType=NUMERIC},
                    xmlparse(content #{messageText,jdbcType=CLOB}),
                    #{processType,jdbcType=VARCHAR},
                    <include refid="base.auditHosts"/>
                   )
    </insert>

    <select id="getById" parameterType="Integer" resultMap="result">
        <include refid="baseSelect"/>
        <where>
            <if test="null != value">
              ipds_message_log_id = #{value}
            </if>
         </where>
    </select>

    <select id="getByMap" resultMap="result">
        <include refid="baseSelect"/>
    </select>

    <update id="update" parameterType="IpdsMessageLog">
        update ipds_message_log
           set processing_details = #{processingDetails,jdbcType=VARCHAR},
               prod_id = #{prodId,jdbcType=NUMERIC},
               <include refid="base.auditSets"/>
         where ipds_message_log_id = #{id,jdbcType=NUMERIC}
    </update>

    <select id="getMpPublicationFromIpds" parameterType="Integer" resultType="java.util.HashMap">
        select Abstract,
               Citation,
               CostCenter,
               Cooperators,
               DigitalObjectIdentifier,
               EditionNumber,
               FinalTitle,
               ipds_internal_id,
               IPNumber,
               Issue,
               JournalTitle,
               NonUSGSPublisher,
               PageRange,
               PhysicalDescription,
               ProductSummary,
               ProductTypeValue,
               PublishedURL,
               PublishingServiceCenter,
               Task,
               USGSSeriesLetter,
               USGSSeriesNumber,
               USGSSeriesTypeValue,
               Volume,
               WorkingTitle
          from (select xmltable.*
                  from xmltable(xmlnamespaces('http://schemas.microsoft.com/ado/2007/08/dataservices' as "d",
                                              'http://schemas.microsoft.com/ado/2007/08/dataservices/metadata' as "m",
                                              'http://www.w3.org/2005/Atom' as "q"),
                                '/q:feed/q:entry'
                                passing (select ipds_message from ipds_message_log where ipds_message_log_id = #{value})
                                columns Abstract text path './/m:properties/d:Abstract',
                                        Citation text path './/m:properties/d:Citation',
                                        CostCenter integer path './/m:properties/d:CostCenter',
                                        Cooperators text path './/m:properties/d:Cooperators',
                                        DigitalObjectIdentifier text path './/m:properties/d:DigitalObjectIdentifier',
                                        EditionNumber text path './/m:properties/d:EditionNumber',
                                        FinalTitle text path './/m:properties/d:FinalTitle',
                                        ipds_internal_id integer path './/m:properties/d:Id',
                                        IPNumber text path './/m:properties/d:IPNumber',
                                        Issue text path './/m:properties/d:Issue',
                                        JournalTitle text path './/m:properties/d:JournalTitle',
                                        NonUSGSPublisher text path './/m:properties/d:NonUSGSPublisher',
                                        PageRange text path './/m:properties/d:PageRange',
                                        PhysicalDescription text path './/m:properties/d:PhysicalDescription',
                                        ProductSummary text path './/m:properties/d:ProductSummary',
                                        ProductTypeValue text path './/m:properties/d:ProductTypeValue',
                                        PublishedURL text path './/m:properties/d:PublishedURL',
                                        PublishingServiceCenter integer path './/m:properties/d:PublishingServiceCenter',
                                        Task text path './/m:properties/d:Task',
                                        USGSSeriesLetter text path './/m:properties/d:USGSSeriesLetter',
                                        USGSSeriesNumber text path './/m:properties/d:USGSSeriesNumber',
                                        USGSSeriesTypeValue text path './/m:properties/d:USGSSeriesTypeValue',
                                        Volume text path './/m:properties/d:Volume',
                                        WorkingTitle text path './/m:properties/d:WorkingTitle'
                               )
               ) x
    </select>

    <select id="getMpPublicationFromSipp" parameterType="Integer" resultType="java.util.HashMap">
        select xmltable.*
          from ipds_message_log,
               xmltable ('/IPDSBureauApprovals/IPDSBureauApproval' passing ipds_message
                         columns
                             ipnumber text path 'IPNumber'
                        )
    </select>

</mapper>
