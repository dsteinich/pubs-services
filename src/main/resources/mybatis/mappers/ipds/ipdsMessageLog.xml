<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="ipdsMessageLog">

    <resultMap id="result" type="IpdsMessageLog" extends="base.result">
        <id property="id" column="ipds_message_log_id"/>
        <result property="messageText" column="ipds_message"/>
        <result property="processingDetails" column="processing_details"/>
        <result property="prodId" column="prod_id"/>
        <result property="processType" column="process_type"/>
    </resultMap>

    <sql id="baseSelect">
        select ipds_message_log_id,
               xmlserialize(content ipds_message as clob no indent) ipds_message,
               processing_details,
               prod_id,
               process_type
          from ipds_message_log
    </sql>

    <insert id="add" parameterType="IpdsMessageLog">
        <selectKey keyProperty="id" resultType="Integer" order="BEFORE">
            select ipds_message_log_seq.nextval id from dual
        </selectKey>
        {call xml_crutch.insert_ipds_message_log (#{id,jdbcType=NUMERIC,mode=IN}, #{messageText,jdbcType=CLOB,mode=IN},
                                                  #{processType,jdbcType=VARCHAR,mode=IN})}
    </insert>

    <select id="getById" parameterType="Integer" resultMap="result">
        <include refid="baseSelect"/>
        <where>
            <if test="null != value">
              ipds_message_log_id = #{value}
            </if>
         </where>
    </select>

    <select id="getByMap" resultMap="result">
        <include refid="baseSelect"/>
    </select>

    <update id="update" parameterType="IpdsMessageLog">
        update ipds_message_log
           set processing_details = #{processingDetails,jdbcType=VARCHAR},
               prod_id = #{prodId,jdbcType=NUMERIC},
               <include refid="base.auditSets"/>
         where ipds_message_log_id = #{id,jdbcType=NUMERIC}
    </update>

    <select id="getMpPublicationFromIpds" parameterType="Integer" resultType="PubMap">
        select Abstract,
               Citation,
               CostCenter,
               Cooperators,
               DigitalObjectIdentifier,
               EditionNumber,
               FinalTitle,
               ipds_internal_id,
               IPNumber,
               Issue,
               JournalTitle,
               NonUSGSPublisher,
               PageRange,
               PhysicalDescription,
               ProductSummary,
               ProductTypeValue,
               PublishedURL,
               PublishingServiceCenter,
               Task,
               USGSSeriesLetter,
               USGSSeriesNumber,
               USGSSeriesTypeValue,
               Volume,
               WorkingTitle
          from (select * from ipds_message_log iml,
               xmltable(xmlnamespaces('http://schemas.microsoft.com/ado/2007/08/dataservices' as "d",
                                      'http://schemas.microsoft.com/ado/2007/08/dataservices/metadata' as "m",
                                      'http://www.w3.org/2005/Atom' as "q"),
                        'for $i in /q:feed/q:entry return $i'
                        passing iml.ipds_message
                        columns Abstract clob path '/q:entry/m:properties/d:Abstract',
                                Citation varchar2(4000 char) path '/q:entry/m:properties/d:Citation',
                                CostCenter number path '/q:entry/m:properties/d:CostCenter',
                                Cooperators varchar2(4000 char) path '/q:entry/m:properties/d:Cooperators',
                                DigitalObjectIdentifier varchar2(2000 char) path '/q:entry/m:properties/d:DigitalObjectIdentifier',
                                EditionNumber varchar2(255 char) path '/q:entry/m:properties/d:EditionNumber',
                                FinalTitle varchar2(2000 char) path '/q:entry/m:properties/d:FinalTitle',
                                ipds_internal_id number path '/q:entry/m:properties/d:Id',
                                IPNumber varchar2(15 char) path '/q:entry/m:properties/d:IPNumber',
                                Issue varchar2(20 char) path '/q:entry/m:properties/d:Issue',
                                JournalTitle varchar2(2000 char) path '/q:entry/m:properties/d:JournalTitle',
                                NonUSGSPublisher varchar2(255 char) path '/q:entry/m:properties/d:NonUSGSPublisher',
                                PageRange varchar2(2000 char) path '/q:entry/m:properties/d:PageRange',
                                PhysicalDescription varchar2(2000 char) path '/q:entry/m:properties/d:PhysicalDescription',
                                ProductSummary clob path '/q:entry/m:properties/d:ProductSummary',
                                ProductTypeValue varchar2(2000 char) path '/q:entry/m:properties/d:ProductTypeValue',
                                PublishedURL varchar2(4000 char) path '/q:entry/m:properties/d:PublishedURL',
                                PublishingServiceCenter number path '/q:entry/m:properties/d:PublishingServiceCenter',
                                Task varchar2(4000 char) path '/q:entry/m:properties/d:Task',
                                USGSSeriesLetter varchar2(20 char) path '/q:entry/m:properties/d:USGSSeriesLetter',
                                USGSSeriesNumber varchar2(20 char) path '/q:entry/m:properties/d:USGSSeriesNumber',
                                USGSSeriesTypeValue varchar2(2000 char) path '/q:entry/m:properties/d:USGSSeriesTypeValue',
                                Volume varchar2(50 char) path '/q:entry/m:properties/d:Volume',
                                WorkingTitle varchar2(2000 char) path '/q:entry/m:properties/d:WorkingTitle'
                                )) x
                        where ipds_message_log_id = #{value}
    </select>

</mapper>
